<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Jeopardy - Google Sheets Edition</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #060ce9; /* Classic Jeopardy blue */
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <!-- URL Input & Team Setup Section -->
    <div id="setup-section" class="bg-blue-900 p-6 rounded-lg shadow-lg mb-6 w-full max-w-2xl text-white">
        <h2 class="text-2xl font-bold text-center mb-4">Game Setup</h2>

        <!-- URL Inputs -->
        <div class="mb-4">
            <label for="questions-url" class="block text-yellow-400 text-sm font-bold mb-2">Questions CSV URL:</label>
            <input type="url" id="questions-url" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-white leading-tight focus:outline-none mb-2" placeholder="Paste Google Sheet CSV URL for questions here">
        </div>
        <div class="mb-6">
            <label for="answers-url" class="block text-yellow-400 text-sm font-bold mb-2">Answers CSV URL:</label>
            <input type="url" id="answers-url" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-white leading-tight focus:outline-none mb-4" placeholder="Paste Google Sheet CSV URL for answers here">
        </div>

        <!-- Team Selection -->
        <div class="mb-4">
            <label class="block text-yellow-400 text-sm font-bold mb-2">Number of Teams:</label>
            <div class="flex flex-wrap space-x-4"> <!-- Use flex-wrap for smaller screens -->
                <label class="flex items-center mr-4 mb-2"> <!-- Add margin-right and bottom -->
                    <input type="radio" name="numTeams" value="1" class="mr-1" checked>
                    1 Team
                </label>
                <label class="flex items-center mr-4 mb-2">
                    <input type="radio" name="numTeams" value="2" class="mr-1">
                    2 Teams
                </label>
                <label class="flex items-center mr-4 mb-2">
                    <input type="radio" name="numTeams" value="3" class="mr-1">
                    3 Teams
                </label>
                <label class="flex items-center mr-4 mb-2">
                    <input type="radio" name="numTeams" value="4" class="mr-1">
                    4 Teams
                </label>
                <label class="flex items-center mb-2">
                    <input type="radio" name="numTeams" value="5" class="mr-1">
                    5 Teams
                </label>
            </div>
        </div>

        <!-- Team Name Inputs -->
        <div id="team-names-inputs" class="mb-6">
            <div id="team-1-name-input-container">
                <label for="team-1-name" class="block text-yellow-400 text-sm font-bold mb-1">Team 1 Name:</label>
                <input type="text" id="team-1-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-white leading-tight focus:outline-none mb-2" placeholder="Team 1">
            </div>
            <div id="team-2-name-input-container" class="hidden">
                <label for="team-2-name" class="block text-yellow-400 text-sm font-bold mb-1">Team 2 Name:</label>
                <input type="text" id="team-2-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-white leading-tight focus:outline-none mb-2" placeholder="Team 2">
            </div>
            <div id="team-3-name-input-container" class="hidden">
                <label for="team-3-name" class="block text-yellow-400 text-sm font-bold mb-1">Team 3 Name:</label>
                <input type="text" id="team-3-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-white leading-tight focus:outline-none mb-2" placeholder="Team 3">
            </div>
            <div id="team-4-name-input-container" class="hidden">
                <label for="team-4-name" class="block text-yellow-400 text-sm font-bold mb-1">Team 4 Name:</label>
                <input type="text" id="team-4-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-white leading-tight focus:outline-none mb-2" placeholder="Team 4">
            </div>
            <div id="team-5-name-input-container" class="hidden">
                <label for="team-5-name" class="block text-yellow-400 text-sm font-bold mb-1">Team 5 Name:</label>
                <input type="text" id="team-5-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-white leading-tight focus:outline-none mb-2" placeholder="Team 5">
            </div>
        </div>

        <button id="load-data-button" class="bg-yellow-500 hover:bg-yellow-600 text-blue-900 font-bold py-2 px-4 rounded w-full transition duration-200 ease-in-out">Start Game</button>
    </div>

    <!-- Status Area -->
    <div id="status-area" class="hidden mt-4 text-center text-yellow-300 mb-4 text-lg">Loading...</div>

    <!-- Game Board -->
    <div id="game-board" class="hidden grid grid-cols-6 gap-1 w-full max-w-4xl mx-auto mt-4">
        <!-- Categories and cells will be generated here by JavaScript -->
    </div>

    <!-- Main Score Display Area (will contain multiple scores) -->
    <div id="main-score-area" class="hidden flex justify-around w-full max-w-4xl mt-6 space-x-4">
        <!-- Team scores will be generated here by JavaScript -->
    </div>

    <!-- Question Modal -->
    <div id="question-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="modal-content relative bg-blue-800 text-white p-8 rounded-lg shadow-xl max-w-lg w-full">
            <button id="close-modal-button" class="absolute top-2 right-3 text-white text-2xl font-bold">&times;</button>
            <div id="modal-category" class="text-lg font-bold text-yellow-400 mb-2">Category</div>
            <div id="modal-points" class="text-sm text-gray-300 mb-4">Points: </div>
            <div id="modal-question" class="text-2xl mb-6">Question text goes here...</div>
            <div id="modal-answer-area" class="hidden">
                <h4 class="text-yellow-400 font-bold mb-2">Answer:</h4>
                <div id="modal-answer" class="text-xl mb-4">Answer text goes here...</div>
                <div class="flex justify-center space-x-4">
                    <button id="correct-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-200 ease-in-out">Correct</button>
                    <button id="incorrect-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition duration-200 ease-in-out">Incorrect</button>
                </div>
            </div>
            <button id="show-answer-button" class="mt-4 bg-yellow-500 hover:bg-yellow-600 text-blue-900 font-bold py-2 px-4 rounded transition duration-200 ease-in-out">Show Answer</button>
            <!-- Score display within the modal -->
            <div id="modal-score-area" class="text-white text-xl font-bold my-4">Current Score: $<span id="modal-score">0</span></div>
        </div>
    </div>

    <script>
        // DOM Elements
        const setupSection = document.getElementById('setup-section');
        const questionsUrlInput = document.getElementById('questions-url');
        const answersUrlInput = document.getElementById('answers-url');
        const loadDataButton = document.getElementById('load-data-button');
        const statusArea = document.getElementById('status-area');
        const gameBoard = document.getElementById('game-board');
        const mainScoreArea = document.getElementById('main-score-area');
        const questionModal = document.getElementById('question-modal');
        const modalScoreArea = document.getElementById('modal-score-area');
        const modalScoreDisplay = document.getElementById('modal-score');
        const teamNameInputsContainer = document.getElementById('team-names-inputs');
        const numTeamsRadios = document.querySelectorAll('input[name="numTeams"]');
        const modalCategory = document.getElementById('modal-category');
        const modalPoints = document.getElementById('modal-points');
        const modalQuestion = document.getElementById('modal-question');
        const modalAnswerArea = document.getElementById('modal-answer-area');
        const modalAnswer = document.getElementById('modal-answer');
        const showAnswerButton = document.getElementById('show-answer-button');
        const closeModalButton = document.getElementById('close-modal-button');
        const correctButton = document.getElementById('correct-button');
        const incorrectButton = document.getElementById('incorrect-button');

        // Game State
        let categories = [];
        let questions = {};
        let teams = []; // Array to hold team objects { name: string, score: number }
        let currentTeamIndex = 0; // Index of the team whose turn it is
        let currentAnswer = '';
        let currentPoints = 0;
        let currentCellElement = null;

        // --- Team Selection Logic ---
        numTeamsRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                const numTeams = parseInt(event.target.value);
                // Loop up to 5 now
                for (let i = 1; i <= 5; i++) {
                    const container = document.getElementById(`team-${i}-name-input-container`);
                    if (container) {
                        container.classList.toggle('hidden', i > numTeams);
                    }
                }
            });
        });

        // --- Load Data & Initialize Game ---
        async function loadData() {
            const questionsUrl = questionsUrlInput.value;
            const answersUrl = answersUrlInput.value;

            if (!questionsUrl || !answersUrl) {
                alert('Please provide both URLs.');
                return;
            }

            // Get Team Info
            const selectedNumTeams = parseInt(document.querySelector('input[name="numTeams"]:checked').value);
            teams = [];
            // Loop up to the selected number of teams (max 5)
            for (let i = 1; i <= selectedNumTeams; i++) {
                const nameInput = document.getElementById(`team-${i}-name`);
                // Check if nameInput exists before accessing value
                const name = nameInput ? (nameInput.value.trim() || `Team ${i}`) : `Team ${i}`; // Default name if empty
                teams.push({ name: name, score: 0 });
            }

            statusArea.classList.remove('hidden');
            statusArea.textContent = 'Loading data...';
            loadDataButton.disabled = true;

            try {
                const questionsResponse = await fetch(questionsUrl);
                const answersResponse = await fetch(answersUrl);

                if (!questionsResponse.ok || !answersResponse.ok) {
                    throw new Error(`HTTP error! status: ${questionsResponse.status} or ${answersResponse.status}`);
                }

                const questionsText = await questionsResponse.text();
                const answersText = await answersResponse.text();

                parseData(questionsText, answersText);
                buildGameBoard();
                initializeScoreboard(); // Setup the main scoreboard

                statusArea.classList.add('hidden');
                setupSection.classList.add('hidden'); // Hide the entire setup section
                gameBoard.classList.remove('hidden');
                mainScoreArea.classList.remove('hidden'); // Show main score display

            } catch (error) {
                console.error('Error loading data:', error);
                statusArea.textContent = `Failed to load data. Error: ${error.message}. Please check URLs, CORS, and sheet sharing settings.`;
                loadDataButton.disabled = false;
            }
        }

        // --- Initialize Scoreboard ---
        function initializeScoreboard() {
            mainScoreArea.innerHTML = ''; // Clear previous scores
            teams.forEach((team, index) => {
                const teamScoreDiv = document.createElement('div');
                teamScoreDiv.id = `team-${index}-display`;
                teamScoreDiv.className = 'text-center text-white p-2 border-2 border-transparent rounded'; // Start transparent
                teamScoreDiv.innerHTML = `
                    <div class="text-xl font-bold">${team.name}</div>
                    <div id="team-${index}-score" class="text-3xl font-bold">$${team.score}</div>
                `;
                mainScoreArea.appendChild(teamScoreDiv);
            });
            updateScoreboardHighlight(); // Initial highlight
            updateModalScoreDisplay(); // Initial modal score display
        }

        // --- Highlight Current Team on Scoreboard ---
        function updateScoreboardHighlight() {
            teams.forEach((_, index) => {
                const teamDisplay = document.getElementById(`team-${index}-display`);
                if (teamDisplay) {
                    if (index === currentTeamIndex) {
                        teamDisplay.classList.remove('border-transparent');
                        teamDisplay.classList.add('border-yellow-400'); // Highlight with yellow border
                    } else {
                        teamDisplay.classList.remove('border-yellow-400');
                        teamDisplay.classList.add('border-transparent'); // Make others transparent
                    }
                }
            });
        }

        // --- Update Score ---
        function updateScore(points) {
            if (teams.length > 0) {
                teams[currentTeamIndex].score += points;
                // Update main scoreboard
                const teamScoreElement = document.getElementById(`team-${currentTeamIndex}-score`);
                if (teamScoreElement) {
                    teamScoreElement.textContent = `$${teams[currentTeamIndex].score}`;
                }
                updateModalScoreDisplay(); // Update score in modal
            }
        }

        // Update the score displayed in the modal (shows current team's score)
        function updateModalScoreDisplay() {
             if (teams.length > 0) {
                modalScoreDisplay.textContent = teams[currentTeamIndex].score;
                // Optional: Update label to show current team name
                modalScoreArea.firstChild.textContent = `${teams[currentTeamIndex].name}'s Score: $`;
             } else {
                 modalScoreDisplay.textContent = '0';
                 modalScoreArea.firstChild.textContent = `Score: $`;
             }
        }

        // --- Handle Correct/Incorrect ---
        function handleCorrect() {
            updateScore(currentPoints);
            markCellAnswered();
            // Switch to the next team
            currentTeamIndex = (currentTeamIndex + 1) % teams.length;
            updateScoreboardHighlight(); // Update highlight after switching turn
            closeModal();
        }

        function handleIncorrect() {
            updateScore(-currentPoints);
            markCellAnswered();
            // Switch to the next team
            currentTeamIndex = (currentTeamIndex + 1) % teams.length;
            updateScoreboardHighlight(); // Update highlight after switching turn
            closeModal();
        }

        // --- Open Question Modal ---
        function openQuestionModal(key, category, points, cellElement) {
            const questionData = questions[key];
            if (!questionData || cellElement.classList.contains('answered')) return;

            modalCategory.textContent = category;
            modalPoints.textContent = `Points: $${points}`;
            modalQuestion.textContent = questionData.question;
            currentAnswer = questionData.answer;
            currentPoints = points;
            currentCellElement = cellElement;

            modalAnswerArea.classList.add('hidden');
            showAnswerButton.classList.remove('hidden');
            correctButton.classList.add('hidden');
            incorrectButton.classList.add('hidden');

            updateModalScoreDisplay(); // Show current team's score when opening
            questionModal.classList.remove('hidden');
        }

        function parseData(questionsCsv, answersCsv) {
            const parseCsvLine = (line) => line.split(',').map(item => item.trim());

            // Filter out comment lines starting with '#' and empty lines
            const questionsLines = questionsCsv.split('\n').filter(line => line.trim() !== '' && !line.trim().startsWith('#'));
            const answersLines = answersCsv.split('\n').filter(line => line.trim() !== '' && !line.trim().startsWith('#'));

            if (questionsLines.length === 0 || answersLines.length === 0) {
                throw new Error("CSV data is empty or invalid (after filtering comments).");
            }

            // The first non-comment line is the header
            categories = parseCsvLine(questionsLines[0]);
            const answerCategories = parseCsvLine(answersLines[0]);

            // Basic validation: Check if category headers match
            if (categories.join(',') !== answerCategories.join(',')) {
                console.warn("Warning: Category headers in questions and answers CSV files do not match.");
                // Decide how to handle: throw error, use questions categories, etc.
                // For now, we'll proceed using the questions categories.
            }

            // Check if the number of data rows match (excluding header)
            if (questionsLines.length !== answersLines.length) {
                 console.warn("Warning: Question and Answer CSVs have different numbers of data rows (after filtering comments).");
            }

            questions = {};
            const numDataRows = Math.min(questionsLines.length, answersLines.length) - 1; // Use the minimum number of rows, excluding header
            const numCategories = categories.length;

            for (let i = 1; i <= numDataRows; i++) { // Start from 1 to skip header
                const questionRow = parseCsvLine(questionsLines[i]);
                const answerRow = parseCsvLine(answersLines[i]);
                const points = i * 100; // Assuming points are 100, 200, etc. based on row index

                if (questionRow.length !== numCategories || answerRow.length !== numCategories) {
                    console.warn(`Warning: Row ${i+1} in CSV does not have the expected number of columns (${numCategories}). Skipping potentially mismatched data.`);
                    // Optionally skip this row or handle partial data
                }

                for (let j = 0; j < numCategories; j++) {
                    // Check bounds defensively, though the warning above might cover this
                    if (j < questionRow.length && j < answerRow.length) {
                        const key = `${categories[j]}_${points}`;
                        questions[key] = {
                            question: questionRow[j] || "N/A",
                            answer: answerRow[j] || "N/A"
                        };
                    }
                }
            }
            console.log("Parsed Categories:", categories);
            // console.log("Parsed Questions:", questions); // Keep this commented unless debugging
        }

        function buildGameBoard() {
            gameBoard.innerHTML = '';
            categories.forEach(category => {
                const categoryCell = document.createElement('div');
                categoryCell.className = 'bg-blue-900 text-white font-bold text-sm h-16 flex items-center justify-center text-center border border-black p-2';
                categoryCell.textContent = category;
                gameBoard.appendChild(categoryCell);
            });

            const numRows = 5;
            for (let i = 1; i <= numRows; i++) {
                categories.forEach(category => {
                    const points = i * 100;
                    const key = `${category}_${points}`;

                    const questionCell = document.createElement('div');
                    questionCell.className = 'jeopardy-cell bg-blue-800 text-yellow-400 font-bold text-2xl h-24 flex items-center justify-center cursor-pointer border border-black transition duration-200 ease-in-out hover:bg-blue-700';
                    questionCell.textContent = `$${points}`;
                    questionCell.dataset.key = key;

                    if (questions[key]) {
                        questionCell.addEventListener('click', () => openQuestionModal(key, category, points, questionCell));
                    } else {
                        questionCell.textContent = '';
                        questionCell.classList.add('opacity-50', 'cursor-not-allowed');
                    }

                    gameBoard.appendChild(questionCell);
                });
            }
        }

        function showAnswer() {
            modalAnswerArea.classList.remove('hidden');
            modalAnswer.textContent = currentAnswer;
            showAnswerButton.classList.add('hidden');
            correctButton.classList.remove('hidden');
            incorrectButton.classList.remove('hidden');
        }

        function markCellAnswered() {
            if (currentCellElement) {
                currentCellElement.classList.remove('bg-blue-800', 'hover:bg-blue-700', 'cursor-pointer');
                currentCellElement.classList.add('answered', 'bg-gray-600', 'text-gray-400', 'cursor-not-allowed', 'pointer-events-none');
                currentCellElement.textContent = '';
                currentCellElement.replaceWith(currentCellElement.cloneNode(true));
            }
        }

        function closeModal() {
            questionModal.classList.add('hidden');
            modalAnswerArea.classList.add('hidden');
            showAnswerButton.classList.remove('hidden');
            correctButton.classList.add('hidden');
            incorrectButton.classList.add('hidden');
            currentCellElement = null;
            currentPoints = 0;
            currentAnswer = '';
        }

        loadDataButton.addEventListener('click', loadData);
        showAnswerButton.addEventListener('click', showAnswer);
        closeModalButton.addEventListener('click', closeModal);
        correctButton.addEventListener('click', handleCorrect);
        incorrectButton.addEventListener('click', handleIncorrect);

        mainScoreArea.classList.add('hidden'); // Hide main score initially
        document.querySelector('input[name="numTeams"]:checked').dispatchEvent(new Event('change'));
    </script>
</body>
</html>
